#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "streamingatof.h"

static inline double myintpow10(int exponent)
{
        double a = 1.0;
        double b = 10.0;
        if (exponent < 0)
        {
		//abort();
                return 1.0 / myintpow10(-exponent);
        }
        // invariant: a * b^exponent stays the same
        while (exponent > 0)
        {
                if ((exponent % 2) == 0)
                {
                        exponent /= 2;
                        b *= b;
                }
                else
                {
                        exponent -= 1;
                        a *= b;
                }
        }
        return a;
}

static double my_atof(const char *data)
{
	struct streaming_atof_ctx sctx;
	struct streaming_atof_ctx *ctx = &sctx;
	int b;
	streaming_atof_init(ctx);

	b = (rand()>>6) % 2;

	size_t len = strlen(data);
	if (b)
	{
		for (size_t i = 0; i < len; i++)
		{
			if (streaming_atof_feed(ctx, &data[i], 1) != 1)
			{
				abort();
			}
		}
	}
	else
	{
		ssize_t slen = (ssize_t)len;
		ssize_t retlen;
		retlen = streaming_atof_feed(ctx, data, len);
		if (retlen != slen)
		{
			printf("feed %s len %zd retlen %zd\n", data, slen, retlen);
			abort();
		}
	}

	return streaming_atof_end(ctx);
}

static void test_number(double d)
{
	char num1[64], num2[64];
	double d2;
	if (!isfinite(d))
	{
		// Let's skip non-finites as they are not valid JSON
		return;
	}
	if (snprintf(num1, sizeof(num1), "%.17g", d) >= (int)sizeof(num1))
	{
		abort();
	}
	d2 = my_atof(num1);
	if (snprintf(num2, sizeof(num2), "%.17g", d2) >= (int)sizeof(num2))
	{
		abort();
	}
	if (strcmp(num1, num2) != 0)
	{
		printf("num %.17g strcmp failure\n", d);
		abort();
	}
}

static void test_string(const char *str)
{
	char num1[64], num2[64];
	double d1, d2;
	d1 = atof(str);
	d2 = my_atof(str);
	if (snprintf(num1, sizeof(num2), "%.17g", d1) >= (int)sizeof(num1))
	{
		abort();
	}
	if (snprintf(num2, sizeof(num2), "%.17g", d2) >= (int)sizeof(num1))
	{
		abort();
	}
	if (d1 != d2)
	{
		printf("str %s cmp failure %.17g %.17g\n", str, d1, d2);
		abort();
	}
	if (strcmp(num1, num2) != 0)
	{
		printf("str %s strcmp failure\n", str);
		abort();
	}
}

int main(int argc, char **argv)
{
	double d;
	int exponent;

	test_number(0.0);
	test_number(-0.0);

	// different representations of positive and negative one
	test_string("1");
	test_string("-1");
	test_string("1e0");
	test_string("-1e0");
	test_string("1e+0");
	test_string("-1e+0");
	test_string("1e-0");
	test_string("-1e-0");
	test_string("1.0");
	test_string("-1.0");
	test_string("1.0e0");
	test_string("-1.0e0");
	test_string("1.0e+0");
	test_string("-1.0e+0");
	test_string("1.0e-0");
	test_string("-1.0e-0");

	// different representations of positive zero
	test_string("0.0");
	test_string("0");
	test_string("0e5");
	test_string("0e-5");
	test_string("0e+5");
	test_string("0.0e5");
	test_string("0.0e-5");
	test_string("0.0e+5");

	// different representations of negative zero
	test_string("-0.0");
	test_string("-0");
	test_string("-0e5");
	test_string("-0e-5");
	test_string("-0e+5");
	test_string("-0.0e5");
	test_string("-0.0e-5");
	test_string("-0.0e+5");

	// huge list of zeros at beginning
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-500");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-400");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-300");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-200");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-20");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-2");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-0");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+0");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+2");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+20");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+200");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+300");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+400");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+500");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e0");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e2");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e20");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e200");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e300");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e400");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e500");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-500");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-400");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-300");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-200");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-20");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-2");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-0");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+0");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+2");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+20");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+200");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+300");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+400");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+500");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e0");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e2");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e20");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e200");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e300");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e400");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e500");

	// Test really long integer part with or without floating point data
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e50");
	printf("succeeds\n");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.0e50");
	printf("succeeds2\n");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	printf("fails\n");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e+50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e-50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e+50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e-50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");

	// Test really long floating point part, either all-zeros or lots of zeros followed by one
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e50");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e+50");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e-50");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e50");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e+50");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e-50");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");

	// More complicated tests, not that many zeros, huge integer part
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e+50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e-50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e+50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e-50");

	// More complicated tests, not that many zeros, huge floating-point part
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105");
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e50");
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e+50");
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e-50");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e50");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e+50");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e-50");


	srand48(1);
	size_t iter;
	for (iter = 0; iter < 10*1000*1000; iter++)
	{
		d = iter;
		test_number(d);
		test_number(-d);
		if (iter % 100000 == 0)
		{
			printf("int %zu\n", iter);
		}
	}
	for (iter = 0; iter < 100*1000*1000; iter++)
	{
		d = drand48();
		exponent = rand() % 661;
		exponent -= 330;
		d *= myintpow10(exponent);
		if (drand48() < 0.5)
		{
			d = -d;
		}
		if (iter % 100000 == 0)
		{
			printf("%zu\n", iter);
		}
		test_number(d);
	}
	return 0;
}
