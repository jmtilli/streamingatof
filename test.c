#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "streamingatof.h"

static double myintpow10(int exponent)
{
        double a = 1.0;
        double b = 10.0;
        if (exponent < 0)
        {
		//abort();
                return 1.0 / myintpow10(-exponent);
        }
        // invariant: a * b^exponent stays the same
        while (exponent > 0)
        {
                if ((exponent % 2) == 0)
                {
                        exponent /= 2;
                        b *= b;
                }
                else
                {
                        exponent -= 1;
                        a *= b;
                }
        }
        return a;
}

static double my_atof(const char *data)
{
	struct streaming_atof_ctx sctx;
	struct streaming_atof_ctx *ctx = &sctx;
	int b;
	size_t len;

	streaming_atof_init(ctx);

	b = (rand()>>6) % 2;

	len = strlen(data);
	if (b)
	{
		for (size_t i = 0; i < len; i++)
		{
			if (streaming_atof_feed(ctx, &data[i], 1) != 1)
			{
				abort();
			}
		}
	}
	else
	{
		ssize_t slen = (ssize_t)len;
		ssize_t retlen;
		retlen = streaming_atof_feed(ctx, data, len);
		if (retlen != slen)
		{
			printf("feed %s len %zd retlen %zd\n", data, slen, retlen);
			abort();
		}
	}

	return streaming_atof_end(ctx);
}

static void test_number(double d)
{
	char num1[64], num2[64];
	double d2;
	if (!isfinite(d))
	{
		// Let's skip non-finites as they are not valid JSON
		return;
	}
	if (snprintf(num1, sizeof(num1), "%.17g", d) >= (int)sizeof(num1))
	{
		abort();
	}
	d2 = my_atof(num1);
	if (snprintf(num2, sizeof(num2), "%.17g", d2) >= (int)sizeof(num2))
	{
		abort();
	}
	if (strcmp(num1, num2) != 0)
	{
		printf("num %.17g strcmp failure\n", d);
		abort();
	}
}

static void test_string(const char *str)
{
	char num1[64], num2[64];
	double d1, d2;
	d1 = atof(str);
	d2 = my_atof(str);
	if (snprintf(num1, sizeof(num2), "%.17g", d1) >= (int)sizeof(num1))
	{
		abort();
	}
	if (snprintf(num2, sizeof(num2), "%.17g", d2) >= (int)sizeof(num1))
	{
		abort();
	}
	if (d1 != d2)
	{
		printf("str %s cmp failure %.17g %.17g\n", str, d1, d2);
		abort();
	}
	if (strcmp(num1, num2) != 0)
	{
		printf("str %s strcmp failure\n", str);
		abort();
	}
}

int main(int argc, char **argv)
{
	double d;
	size_t iter, fmtiter;
	int exponent;
	char buf[1024];
	const char *random_fmt;
	const char *random_fmts[] = {
		"%.0e", "%.0E", "%.0f", "%.0F", "%.0g", "%.0G",
		"%.1e", "%.1E", "%.1f", "%.1F", "%.1g", "%.1G",
		"%.2e", "%.2E", "%.2f", "%.2F", "%.2g", "%.2G",
		"%.3e", "%.3E", "%.3f", "%.3F", "%.3g", "%.3G",
		"%.4e", "%.4E", "%.4f", "%.4F", "%.4g", "%.4G",
		"%.5e", "%.5E", "%.5f", "%.5F", "%.5g", "%.5G",
		"%.6e", "%.6E", "%.6f", "%.6F", "%.6g", "%.6G",
		"%.7e", "%.7E", "%.7f", "%.7F", "%.7g", "%.7G",
		"%.8e", "%.8E", "%.8f", "%.8F", "%.8g", "%.8G",
		"%.9e", "%.9E", "%.9f", "%.9F", "%.9g", "%.9G",

		"%.10e", "%.10E", "%.10f", "%.10F", "%.10g", "%.10G",
		"%.11e", "%.11E", "%.11f", "%.11F", "%.11g", "%.11G",
		"%.12e", "%.12E", "%.12f", "%.12F", "%.12g", "%.12G",
		"%.13e", "%.13E", "%.13f", "%.13F", "%.13g", "%.13G",
		"%.14e", "%.14E", "%.14f", "%.14F", "%.14g", "%.14G",
		"%.15e", "%.15E", "%.15f", "%.15F", "%.15g", "%.15G",
		"%.16e", "%.16E", "%.16f", "%.16F", "%.16g", "%.16G",
		"%.17e", "%.17E", "%.17f", "%.17F", "%.17g", "%.17G",
		"%.18e", "%.18E", "%.18f", "%.18F", "%.18g", "%.18G",
		"%.19e", "%.19E", "%.19f", "%.19F", "%.19g", "%.19G",

		"%.20e", "%.20E", "%.20f", "%.20F", "%.20g", "%.20G",
		"%.21e", "%.21E", "%.21f", "%.21F", "%.21g", "%.21G",
		"%.22e", "%.22E", "%.22f", "%.22F", "%.22g", "%.22G",
		"%.23e", "%.23E", "%.23f", "%.23F", "%.23g", "%.23G",
		"%.24e", "%.24E", "%.24f", "%.24F", "%.24g", "%.24G",
		"%.25e", "%.25E", "%.25f", "%.25F", "%.25g", "%.25G",
		"%.26e", "%.26E", "%.26f", "%.26F", "%.26g", "%.26G",
		"%.27e", "%.27E", "%.27f", "%.27F", "%.27g", "%.27G",
		"%.28e", "%.28E", "%.28f", "%.28F", "%.28g", "%.28G",
		"%.29e", "%.29E", "%.29f", "%.29F", "%.29g", "%.29G",

		"%.30e", "%.30E", "%.30f", "%.30F", "%.30g", "%.30G",
		"%.31e", "%.31E", "%.31f", "%.31F", "%.31g", "%.31G",
		"%.32e", "%.32E", "%.32f", "%.32F", "%.32g", "%.32G",
		"%.33e", "%.33E", "%.33f", "%.33F", "%.33g", "%.33G",
		"%.34e", "%.34E", "%.34f", "%.34F", "%.34g", "%.34G",
		"%.35e", "%.35E", "%.35f", "%.35F", "%.35g", "%.35G",
		"%.36e", "%.36E", "%.36f", "%.36F", "%.36g", "%.36G",
		"%.37e", "%.37E", "%.37f", "%.37F", "%.37g", "%.37G",
		"%.38e", "%.38E", "%.38f", "%.38F", "%.38g", "%.38G",
		"%.39e", "%.39E", "%.39f", "%.39F", "%.39g", "%.39G",

		"%.40e", "%.40E", "%.40f", "%.40F", "%.40g", "%.40G",
		"%.41e", "%.41E", "%.41f", "%.41F", "%.41g", "%.41G",
		"%.42e", "%.42E", "%.42f", "%.42F", "%.42g", "%.42G",
		"%.43e", "%.43E", "%.43f", "%.43F", "%.43g", "%.43G",
		"%.44e", "%.44E", "%.44f", "%.44F", "%.44g", "%.44G",
		"%.45e", "%.45E", "%.45f", "%.45F", "%.45g", "%.45G",
		"%.46e", "%.46E", "%.46f", "%.46F", "%.46g", "%.46G",
		"%.47e", "%.47E", "%.47f", "%.47F", "%.47g", "%.47G",
		"%.48e", "%.48E", "%.48f", "%.48F", "%.48g", "%.48G",
		"%.49e", "%.49E", "%.49f", "%.49F", "%.49g", "%.49G",

		"%.50e", "%.50E", "%.50f", "%.50F", "%.50g", "%.50G",
		"%.51e", "%.51E", "%.51f", "%.51F", "%.51g", "%.51G",
		"%.52e", "%.52E", "%.52f", "%.52F", "%.52g", "%.52G",
		"%.53e", "%.53E", "%.53f", "%.53F", "%.53g", "%.53G",
		"%.54e", "%.54E", "%.54f", "%.54F", "%.54g", "%.54G",
		"%.55e", "%.55E", "%.55f", "%.55F", "%.55g", "%.55G",
		"%.56e", "%.56E", "%.56f", "%.56F", "%.56g", "%.56G",
		"%.57e", "%.57E", "%.57f", "%.57F", "%.57g", "%.57G",
		"%.58e", "%.58E", "%.58f", "%.58F", "%.58g", "%.58G",
		"%.59e", "%.59E", "%.59f", "%.59F", "%.59g", "%.59G",

		"%.60e", "%.60E", "%.60f", "%.60F", "%.60g", "%.60G",
		"%.61e", "%.61E", "%.61f", "%.61F", "%.61g", "%.61G",
		"%.62e", "%.62E", "%.62f", "%.62F", "%.62g", "%.62G",
		"%.63e", "%.63E", "%.63f", "%.63F", "%.63g", "%.63G",
		"%.64e", "%.64E", "%.64f", "%.64F", "%.64g", "%.64G",
		"%.65e", "%.65E", "%.65f", "%.65F", "%.65g", "%.65G",
		"%.66e", "%.66E", "%.66f", "%.66F", "%.66g", "%.66G",
		"%.67e", "%.67E", "%.67f", "%.67F", "%.67g", "%.67G",
		"%.68e", "%.68E", "%.68f", "%.68F", "%.68g", "%.68G",
		"%.69e", "%.69E", "%.69f", "%.69F", "%.69g", "%.69G",

		"%.70e", "%.70E", "%.70f", "%.70F", "%.70g", "%.70G",
		"%.71e", "%.71E", "%.71f", "%.71F", "%.71g", "%.71G",
		"%.72e", "%.72E", "%.72f", "%.72F", "%.72g", "%.72G",
		"%.73e", "%.73E", "%.73f", "%.73F", "%.73g", "%.73G",
		"%.74e", "%.74E", "%.74f", "%.74F", "%.74g", "%.74G",
		"%.75e", "%.75E", "%.75f", "%.75F", "%.75g", "%.75G",
		"%.76e", "%.76E", "%.76f", "%.76F", "%.76g", "%.76G",
		"%.77e", "%.77E", "%.77f", "%.77F", "%.77g", "%.77G",
		"%.78e", "%.78E", "%.78f", "%.78F", "%.78g", "%.78G",
		"%.79e", "%.79E", "%.79f", "%.79F", "%.79g", "%.79G",

		"%.80e", "%.80E", "%.80f", "%.80F", "%.80g", "%.80G",
		"%.81e", "%.81E", "%.81f", "%.81F", "%.81g", "%.81G",
		"%.82e", "%.82E", "%.82f", "%.82F", "%.82g", "%.82G",
		"%.83e", "%.83E", "%.83f", "%.83F", "%.83g", "%.83G",
		"%.84e", "%.84E", "%.84f", "%.84F", "%.84g", "%.84G",
		"%.85e", "%.85E", "%.85f", "%.85F", "%.85g", "%.85G",
		"%.86e", "%.86E", "%.86f", "%.86F", "%.86g", "%.86G",
		"%.87e", "%.87E", "%.87f", "%.87F", "%.87g", "%.87G",
		"%.88e", "%.88E", "%.88f", "%.88F", "%.88g", "%.88G",
		"%.89e", "%.89E", "%.89f", "%.89F", "%.89g", "%.89G",

		"%.90e", "%.90E", "%.90f", "%.90F", "%.90g", "%.90G",
		"%.91e", "%.91E", "%.91f", "%.91F", "%.91g", "%.91G",
		"%.92e", "%.92E", "%.92f", "%.92F", "%.92g", "%.92G",
		"%.93e", "%.93E", "%.93f", "%.93F", "%.93g", "%.93G",
		"%.94e", "%.94E", "%.94f", "%.94F", "%.94g", "%.94G",
		"%.95e", "%.95E", "%.95f", "%.95F", "%.95g", "%.95G",
		"%.96e", "%.96E", "%.96f", "%.96F", "%.96g", "%.96G",
		"%.97e", "%.97E", "%.97f", "%.97F", "%.97g", "%.97G",
		"%.98e", "%.98E", "%.98f", "%.98F", "%.98g", "%.98G",
		"%.99e", "%.99E", "%.99f", "%.99F", "%.99g", "%.99G",

		"%+.0e", "%+.0E", "%+.0f", "%+.0F", "%+.0g", "%+.0G",
		"%+.1e", "%+.1E", "%+.1f", "%+.1F", "%+.1g", "%+.1G",
		"%+.2e", "%+.2E", "%+.2f", "%+.2F", "%+.2g", "%+.2G",
		"%+.3e", "%+.3E", "%+.3f", "%+.3F", "%+.3g", "%+.3G",
		"%+.4e", "%+.4E", "%+.4f", "%+.4F", "%+.4g", "%+.4G",
		"%+.5e", "%+.5E", "%+.5f", "%+.5F", "%+.5g", "%+.5G",
		"%+.6e", "%+.6E", "%+.6f", "%+.6F", "%+.6g", "%+.6G",
		"%+.7e", "%+.7E", "%+.7f", "%+.7F", "%+.7g", "%+.7G",
		"%+.8e", "%+.8E", "%+.8f", "%+.8F", "%+.8g", "%+.8G",
		"%+.9e", "%+.9E", "%+.9f", "%+.9F", "%+.9g", "%+.9G",

		"%+.10e", "%+.10E", "%+.10f", "%+.10F", "%+.10g", "%+.10G",
		"%+.11e", "%+.11E", "%+.11f", "%+.11F", "%+.11g", "%+.11G",
		"%+.12e", "%+.12E", "%+.12f", "%+.12F", "%+.12g", "%+.12G",
		"%+.13e", "%+.13E", "%+.13f", "%+.13F", "%+.13g", "%+.13G",
		"%+.14e", "%+.14E", "%+.14f", "%+.14F", "%+.14g", "%+.14G",
		"%+.15e", "%+.15E", "%+.15f", "%+.15F", "%+.15g", "%+.15G",
		"%+.16e", "%+.16E", "%+.16f", "%+.16F", "%+.16g", "%+.16G",
		"%+.17e", "%+.17E", "%+.17f", "%+.17F", "%+.17g", "%+.17G",
		"%+.18e", "%+.18E", "%+.18f", "%+.18F", "%+.18g", "%+.18G",
		"%+.19e", "%+.19E", "%+.19f", "%+.19F", "%+.19g", "%+.19G",

		"%+.20e", "%+.20E", "%+.20f", "%+.20F", "%+.20g", "%+.20G",
		"%+.21e", "%+.21E", "%+.21f", "%+.21F", "%+.21g", "%+.21G",
		"%+.22e", "%+.22E", "%+.22f", "%+.22F", "%+.22g", "%+.22G",
		"%+.23e", "%+.23E", "%+.23f", "%+.23F", "%+.23g", "%+.23G",
		"%+.24e", "%+.24E", "%+.24f", "%+.24F", "%+.24g", "%+.24G",
		"%+.25e", "%+.25E", "%+.25f", "%+.25F", "%+.25g", "%+.25G",
		"%+.26e", "%+.26E", "%+.26f", "%+.26F", "%+.26g", "%+.26G",
		"%+.27e", "%+.27E", "%+.27f", "%+.27F", "%+.27g", "%+.27G",
		"%+.28e", "%+.28E", "%+.28f", "%+.28F", "%+.28g", "%+.28G",
		"%+.29e", "%+.29E", "%+.29f", "%+.29F", "%+.29g", "%+.29G",

		"%+.30e", "%+.30E", "%+.30f", "%+.30F", "%+.30g", "%+.30G",
		"%+.31e", "%+.31E", "%+.31f", "%+.31F", "%+.31g", "%+.31G",
		"%+.32e", "%+.32E", "%+.32f", "%+.32F", "%+.32g", "%+.32G",
		"%+.33e", "%+.33E", "%+.33f", "%+.33F", "%+.33g", "%+.33G",
		"%+.34e", "%+.34E", "%+.34f", "%+.34F", "%+.34g", "%+.34G",
		"%+.35e", "%+.35E", "%+.35f", "%+.35F", "%+.35g", "%+.35G",
		"%+.36e", "%+.36E", "%+.36f", "%+.36F", "%+.36g", "%+.36G",
		"%+.37e", "%+.37E", "%+.37f", "%+.37F", "%+.37g", "%+.37G",
		"%+.38e", "%+.38E", "%+.38f", "%+.38F", "%+.38g", "%+.38G",
		"%+.39e", "%+.39E", "%+.39f", "%+.39F", "%+.39g", "%+.39G",

		"%+.40e", "%+.40E", "%+.40f", "%+.40F", "%+.40g", "%+.40G",
		"%+.41e", "%+.41E", "%+.41f", "%+.41F", "%+.41g", "%+.41G",
		"%+.42e", "%+.42E", "%+.42f", "%+.42F", "%+.42g", "%+.42G",
		"%+.43e", "%+.43E", "%+.43f", "%+.43F", "%+.43g", "%+.43G",
		"%+.44e", "%+.44E", "%+.44f", "%+.44F", "%+.44g", "%+.44G",
		"%+.45e", "%+.45E", "%+.45f", "%+.45F", "%+.45g", "%+.45G",
		"%+.46e", "%+.46E", "%+.46f", "%+.46F", "%+.46g", "%+.46G",
		"%+.47e", "%+.47E", "%+.47f", "%+.47F", "%+.47g", "%+.47G",
		"%+.48e", "%+.48E", "%+.48f", "%+.48F", "%+.48g", "%+.48G",
		"%+.49e", "%+.49E", "%+.49f", "%+.49F", "%+.49g", "%+.49G",

		"%+.50e", "%+.50E", "%+.50f", "%+.50F", "%+.50g", "%+.50G",
		"%+.51e", "%+.51E", "%+.51f", "%+.51F", "%+.51g", "%+.51G",
		"%+.52e", "%+.52E", "%+.52f", "%+.52F", "%+.52g", "%+.52G",
		"%+.53e", "%+.53E", "%+.53f", "%+.53F", "%+.53g", "%+.53G",
		"%+.54e", "%+.54E", "%+.54f", "%+.54F", "%+.54g", "%+.54G",
		"%+.55e", "%+.55E", "%+.55f", "%+.55F", "%+.55g", "%+.55G",
		"%+.56e", "%+.56E", "%+.56f", "%+.56F", "%+.56g", "%+.56G",
		"%+.57e", "%+.57E", "%+.57f", "%+.57F", "%+.57g", "%+.57G",
		"%+.58e", "%+.58E", "%+.58f", "%+.58F", "%+.58g", "%+.58G",
		"%+.59e", "%+.59E", "%+.59f", "%+.59F", "%+.59g", "%+.59G",

		"%+.60e", "%+.60E", "%+.60f", "%+.60F", "%+.60g", "%+.60G",
		"%+.61e", "%+.61E", "%+.61f", "%+.61F", "%+.61g", "%+.61G",
		"%+.62e", "%+.62E", "%+.62f", "%+.62F", "%+.62g", "%+.62G",
		"%+.63e", "%+.63E", "%+.63f", "%+.63F", "%+.63g", "%+.63G",
		"%+.64e", "%+.64E", "%+.64f", "%+.64F", "%+.64g", "%+.64G",
		"%+.65e", "%+.65E", "%+.65f", "%+.65F", "%+.65g", "%+.65G",
		"%+.66e", "%+.66E", "%+.66f", "%+.66F", "%+.66g", "%+.66G",
		"%+.67e", "%+.67E", "%+.67f", "%+.67F", "%+.67g", "%+.67G",
		"%+.68e", "%+.68E", "%+.68f", "%+.68F", "%+.68g", "%+.68G",
		"%+.69e", "%+.69E", "%+.69f", "%+.69F", "%+.69g", "%+.69G",

		"%+.70e", "%+.70E", "%+.70f", "%+.70F", "%+.70g", "%+.70G",
		"%+.71e", "%+.71E", "%+.71f", "%+.71F", "%+.71g", "%+.71G",
		"%+.72e", "%+.72E", "%+.72f", "%+.72F", "%+.72g", "%+.72G",
		"%+.73e", "%+.73E", "%+.73f", "%+.73F", "%+.73g", "%+.73G",
		"%+.74e", "%+.74E", "%+.74f", "%+.74F", "%+.74g", "%+.74G",
		"%+.75e", "%+.75E", "%+.75f", "%+.75F", "%+.75g", "%+.75G",
		"%+.76e", "%+.76E", "%+.76f", "%+.76F", "%+.76g", "%+.76G",
		"%+.77e", "%+.77E", "%+.77f", "%+.77F", "%+.77g", "%+.77G",
		"%+.78e", "%+.78E", "%+.78f", "%+.78F", "%+.78g", "%+.78G",
		"%+.79e", "%+.79E", "%+.79f", "%+.79F", "%+.79g", "%+.79G",

		"%+.80e", "%+.80E", "%+.80f", "%+.80F", "%+.80g", "%+.80G",
		"%+.81e", "%+.81E", "%+.81f", "%+.81F", "%+.81g", "%+.81G",
		"%+.82e", "%+.82E", "%+.82f", "%+.82F", "%+.82g", "%+.82G",
		"%+.83e", "%+.83E", "%+.83f", "%+.83F", "%+.83g", "%+.83G",
		"%+.84e", "%+.84E", "%+.84f", "%+.84F", "%+.84g", "%+.84G",
		"%+.85e", "%+.85E", "%+.85f", "%+.85F", "%+.85g", "%+.85G",
		"%+.86e", "%+.86E", "%+.86f", "%+.86F", "%+.86g", "%+.86G",
		"%+.87e", "%+.87E", "%+.87f", "%+.87F", "%+.87g", "%+.87G",
		"%+.88e", "%+.88E", "%+.88f", "%+.88F", "%+.88g", "%+.88G",
		"%+.89e", "%+.89E", "%+.89f", "%+.89F", "%+.89g", "%+.89G",

		"%+.90e", "%+.90E", "%+.90f", "%+.90F", "%+.90g", "%+.90G",
		"%+.91e", "%+.91E", "%+.91f", "%+.91F", "%+.91g", "%+.91G",
		"%+.92e", "%+.92E", "%+.92f", "%+.92F", "%+.92g", "%+.92G",
		"%+.93e", "%+.93E", "%+.93f", "%+.93F", "%+.93g", "%+.93G",
		"%+.94e", "%+.94E", "%+.94f", "%+.94F", "%+.94g", "%+.94G",
		"%+.95e", "%+.95E", "%+.95f", "%+.95F", "%+.95g", "%+.95G",
		"%+.96e", "%+.96E", "%+.96f", "%+.96F", "%+.96g", "%+.96G",
		"%+.97e", "%+.97E", "%+.97f", "%+.97F", "%+.97g", "%+.97G",
		"%+.98e", "%+.98E", "%+.98f", "%+.98F", "%+.98g", "%+.98G",
		"%+.99e", "%+.99E", "%+.99f", "%+.99F", "%+.99g", "%+.99G",
	};

	test_number(0.0);
	test_number(-0.0);

	// different representations of positive and negative one
	test_string("1");
	test_string("-1");
	test_string("1e0");
	test_string("-1e0");
	test_string("1e+0");
	test_string("-1e+0");
	test_string("1e-0");
	test_string("-1e-0");
	test_string("1.0");
	test_string("-1.0");
	test_string("1.0e0");
	test_string("-1.0e0");
	test_string("1.0e+0");
	test_string("-1.0e+0");
	test_string("1.0e-0");
	test_string("-1.0e-0");

	// different representations of positive zero
	test_string("0.0");
	test_string("0");
	test_string("0e5");
	test_string("0e-5");
	test_string("0e+5");
	test_string("0.0e5");
	test_string("0.0e-5");
	test_string("0.0e+5");

	// different representations of negative zero
	test_string("-0.0");
	test_string("-0");
	test_string("-0e5");
	test_string("-0e-5");
	test_string("-0e+5");
	test_string("-0.0e5");
	test_string("-0.0e-5");
	test_string("-0.0e+5");

	// huge list of zeros at beginning
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-500");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-400");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-300");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-200");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-20");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-2");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-0");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+0");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+2");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+20");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+200");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+300");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+400");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+500");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e0");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e2");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e20");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e200");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e300");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e400");
	test_string("0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e500");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-500");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-400");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-300");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-200");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-20");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-2");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e-0");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+0");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+2");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+20");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+200");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+300");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+400");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e+500");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e0");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e2");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e20");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e200");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e300");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e400");
	test_string("-0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005e500");

	// Test really long integer part with or without floating point data
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.0e50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e+50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e-50");
	test_string("500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e+50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.1e-50");
	test_string("-500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");

	// Test really long floating point part, either all-zeros or lots of zeros followed by one
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e50");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e+50");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e-50");
	test_string("5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e50");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e50");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e+50");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e+50");
	test_string("-5.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e-50");
	test_string("-5.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-50");

	// More complicated tests, not that many zeros, huge integer part
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e+50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e-50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e+50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("-897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510.5e-50");

	// More complicated tests, not that many zeros, huge floating-point part
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105");
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e50");
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e+50");
	test_string("0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e-50");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e50");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e50");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e+50");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e+50");
	test_string("-0.897531457136785019791571398657169850168167101475197610670568761098759391086795081769138579413067591895614319867180967195510e-50");
	test_string("-0.8975314571367850197915713986571698501681671014751976106705687610987593910867950817691385794130675918956143198671809671955105e-50");


	srand48(1);
	for (iter = 0; iter < 10*1000; iter++)
	{
		d = (double)iter;
		test_number(d);
		test_number(-d);
		if (iter % 100 == 0)
		{
			printf("thorough int %zu\n", iter);
		}
		for (fmtiter = 0; fmtiter < sizeof(random_fmts)/sizeof(*random_fmts); fmtiter++)
		{
			random_fmt = random_fmts[fmtiter];
			if (snprintf(buf, sizeof(buf), random_fmt, d) >= (int)sizeof(buf))
			{
				abort();
			}
			test_string(buf);
			if (snprintf(buf, sizeof(buf), random_fmt, -d) >= (int)sizeof(buf))
			{
				abort();
			}
			test_string(buf);
		}
	}
	for (iter = 0; iter < 10*1000*1000; iter++)
	{
		d = (double)iter;
		test_number(d);
		test_number(-d);
		if (iter % 100000 == 0)
		{
			printf("less thorough int %zu\n", iter);
		}
		random_fmt = random_fmts[((unsigned)rand()) % (sizeof(random_fmts)/sizeof(*random_fmts))];
		if (snprintf(buf, sizeof(buf), random_fmt, d) >= (int)sizeof(buf))
		{
			abort();
		}
		test_string(buf);
		if (snprintf(buf, sizeof(buf), random_fmt, -d) >= (int)sizeof(buf))
		{
			abort();
		}
		test_string(buf);
	}
	for (iter = 0; iter < 100*1000*1000; iter++)
	{
		d = drand48();
		exponent = rand() % 661;
		exponent -= 330;
		d *= myintpow10(exponent);
		if (drand48() < 0.5)
		{
			d = -d;
		}
		if (iter % 100000 == 0)
		{
			printf("%zu\n", iter);
		}
		test_number(d);

		if (isfinite(d))
		{
			random_fmt = random_fmts[((unsigned)rand()) % (sizeof(random_fmts)/sizeof(*random_fmts))];
			if (snprintf(buf, sizeof(buf), random_fmt, d) >= (int)sizeof(buf))
			{
				abort();
			}
			test_string(buf);
		}
	}
	return 0;
}
